- name: Create VMs on Proxmox
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/infrastructure.yml
    - ../vars/vault.yml
  tasks:
    - name: Apply create_vm
      ansible.builtin.include_role:
        name: create_vm
      vars:
        create_vm_node: "{{ template_node }}"
        create_vm_target: "{{ item.target }}"
        create_vm_name: "{{ item.name }}"
        create_vm_newvmid: "{{ item.vmid }}"
        create_vm_vmid: "{{ template_vmid }}"
        create_vm_cores: "{{ item.cores }}"
        create_vm_memory: "{{ item.memory }}"
        create_vm_ip: "{{ item.ip }}"
        create_vm_gateway: "{{ gateway }}"
        create_vm_disk_size_gb: "{{ item.disk_size_gb }}"
        create_vm_cloud_init_user: "{{ cloud_init_user }}"
        create_vm_public_ssh_key: "{{ lookup('ansible.builtin.file', '{{ ssh_key1 }}') }}"
      loop: "{{ infrastructure }}"

- name: Harden VMs
  hosts: all_infra
  become: true
  gather_facts: false
  tasks:
    - name: Apply create_vm
      ansible.builtin.include_role:
        name: vm_hardening

- name: Install HA Proxy
  hosts: haproxy
  become: true
  gather_facts: false

  roles:
    - geerlingguy.haproxy

  vars:
    haproxy_stats_user: "{{ haproxy_username }}"
    haproxy_stats_password: "{{ haproxy_password }}"
    haproxy_bind_address: "0.0.0.0:80"
    haproxy_frontend_backend_servers:
      - {name: "server1", address: "192.168.1.10:8080"}
      - {name: "server2", address: "192.168.1.11:8080"}

  tasks:
    - name: Enable HAProxy service
      ansible.builtin.systemd:
        name: haproxy
        state: started
        enabled: true

- name: Install keepalived
  hosts: haproxy
  become: true
  gather_facts: false

  vars_files:
    - ../vars/keepalived.yml

  roles:
    - hifis.toolkit.keepalived
